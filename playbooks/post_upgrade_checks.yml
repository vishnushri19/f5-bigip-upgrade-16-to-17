---
- name: Post-Upgrade Checks for BIG-IP
  hosts: bigip
  gather_facts: no
  connection: local

  collections:
    - f5networks.f5_modules

  tasks:
    - name: Verify BIG-IP version after upgrade
      bigip_device_info:
        gather_subset:
          - system-info
        provider:
          server: "{{ ansible_host }}"
          user: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          validate_certs: no
      register: upgraded_info

    - name: Display upgraded version
      debug:
        msg: "BIG-IP is now running version: {{ upgraded_info.ansible_facts.system_info.product_version }}"

    - name: Check device status
      bigip_device_info:
        gather_subset:
          - ltm-virtuals
        provider:
          server: "{{ ansible_host }}"
          user: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          validate_certs: no
      register: device_status

    - name: Check HA status if applicable
      bigip_device_info:
        gather_subset:
          - failover-status
        provider:
          server: "{{ ansible_host }}"
          user: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          validate_certs: no
      register: failover_status
      ignore_errors: true

    - name: Success summary
      debug:
        msg: |
          Upgrade completed successfully!
          New version: {{ upgraded_info.ansible_facts.system_info.product_version }}
          Device is operational and ready
