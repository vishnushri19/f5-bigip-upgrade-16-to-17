---
- name: Pre-Upgrade Checks for BIG-IP
  hosts: bigip
  gather_facts: no
  connection: local
  
  collections:
    - f5networks.f5_modules

  tasks:
    - name: Get current BIG-IP version
      bigip_device_info:
        gather_subset:
          - system-info
        provider:
          server: "{{ ansible_host }}"
          user: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          validate_certs: no
      register: device_info

    - name: Display current version
      debug:
        msg: "Current BIG-IP version is: {{ device_info.ansible_facts.system_info.product_version }}"

    - name: Check available disk space
      bigip_device_info:
        gather_subset:
          - virtual-servers
        provider:
          server: "{{ ansible_host }}"
          user: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          validate_certs: no
      register: disk_info

    - name: Backup running configuration
      bigip_config:
        provider:
          server: "{{ ansible_host }}"
          user: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          validate_certs: no
        backup: yes
      register: config_backup

    - name: Display backup status
      debug:
        msg: "Configuration backed up successfully"

    - name: Verify ready for upgrade
      debug:
        msg: "Pre-checks passed - ready for upgrade"
